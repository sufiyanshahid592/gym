;(function(){var attendance={init:function(){if($('.attendance').length==1&&$('.promotions').length==0){if($('.profile').length==1){this.attendanceEvents(".attendance td");}else{this.initAttendance();}}
if($('.attendance-overview').length==1){this.initOverview();}else if($('.checkins-list').length==1){this.initCheckins();}
if($('.member-attendance').length==1){this.initMembers();}
if($('.width.sessions').length==1){this.initSessions();}
if($('.multi-checkin').length==1){this.initMultiCheckin();}
if($('.attendance-settings').length==1){this.initSettings();}
if($('.promotions').length==1){this.initPromotions();}
if($('.promotion-form').length==1){this.initPromote();}},initAttendance:function(){var self=this;var NameData=MemberData;var CodeData={};var IDData={};for(var i in MemberData){var row=MemberData[i];IDData[row['id']]=row;CodeData[row['code']]=row;}
$('.signin-sessions .scroller li').click(function(e){self.pickerEvent(this);});$(window).click(function(){$('.event-popup').hide();$('.sessions').removeClass('open');}).keypress(function(e){if(!$(e.target).is('input, textarea')){if(e.key=='I'||e.key=='D'){var bc=$("input[name='barcode']");bc.val(bc.val()+e.key);window.setTimeout(function(){bc.val('');},250);}else if((e.which>=48&&e.which<=57)||(95<e.which&&e.which<106)){if($('#signin').is(":visible")){if(e.key=='2'||e.key=='8'){if($('.signin-sessions .checked').length==0){$('.signin-sessions .active:first').addClass('checked');}else{var checked=$('.signin-sessions .checked');var avail=$(".signin-sessions li.active");var index=avail.index(checked);$('.signin-sessions .checked').removeClass('checked');if(e.key=='2'){index=index==0?avail.length-1:index-1;}else{index=index==avail.length-1?0:index+1;}
avail.eq(index).addClass('checked');}}}else{var input=$("input.code");input.val(input.val()+e.key);}}else if(e.which==13){if($('#signin').is(":visible")){if($('.signin-sessions .checked').length==0){$('.signin-sessions .active:first').addClass('checked');}
self.signIn();}else{self.numericSignIn(CodeData,IDData);}}}}).keydown(function(e){if(!$(e.target).is('input, textarea')){if(e.which==8){e.preventDefault();var input=$("input.code");input.val(input.val().substr(0,input.val().length-1));}}});$('.add-unscheduled').click(function(e){e.stopPropagation();$('.event-popup').removeClass('editing');$('.event-popup').show().css('top','').find("input[name='title']").val('').focus();});$('.event-popup').click(function(e){e.stopPropagation();});$('.sessions li .edit').click(function(e){e.stopPropagation();self.editEvent(this);});$('.event-popup').submit(function(e){e.preventDefault();var popup=$(this);var data=$(this).serialize();var button=$(this).find('button:visible');button.prop('disabled',true).data('html',button.html());var action=$(this).attr('action');if(popup.is('.editing')){button.html('Saving <i class="spinner"></i>');action='manager/gym/saveevent';}else{button.html('Creating <i class="spinner"></i>');}
$.post(action,data,function(response){button.html(button.data('html')).prop('disabled',false);if(response.success){popup.hide();if(!popup.is('.editing')){var event=$(response.event).prependTo($('.attendance .sessions .unscheduled ul'));$('.attendance .sessions .unscheduled').show();var second=event.clone();$('.signin-sessions .unscheduled ul').prepend(second);$('.signin-sessions .unscheduled').show();$('.sessions .placeholder').hide();}else{var id=popup.find("input[name='id']").val();var origin=$("li[attr-id='"+id+"']");var event=$(response.event).insertAfter(origin);origin.remove();}
$(event).find('.edit').click(function(e){e.stopPropagation();self.editEvent(this);});$(second).click(function(e){self.pickerEvent(this);});}else if(response.errors){for(var i in response.errors){var el=popup.find("[name='"+i+"']");if(el.length==0){el=popup.find('button');}
var error=response.errors[i];if(typeof(error)=='object'){for(var i in error){error=error[i];}}
mor.error(el,error);}}},'json');});$('.event-popup .remove-event').click(function(){self.removeEvent($(".event-popup input[name='id']").val());$('.event-popup').hide();});var input=$('.attendance .search input');input.autocomplete({minLength:3,source:NameData,select:function(event,ui){self.showSigninPopup(ui.item);$('.attendance .search input').val('').blur();return false;}}).autocomplete("instance")._renderItem=function(ul,item){var avatar=mor.main.avatar(item.photo,item.label);return $("<li>").append('<a>'+avatar+item.label+'<small>'+(item.status=='Frozen'?'Frozen':item.type)+'</small>'+"</a>").appendTo(ul);};input.autocomplete('widget').off('mouseenter');$('.attendance .code input').keyup(function(e){var val=$(this).val();$('.code .error-message').remove();if(val!=''){$('.attendance .clear-code').show();}else{$('.attendance .clear-code').hide();}
if(e.which==13){self.numericSignIn(CodeData,IDData);}}).change(function(){var val=$(this).val();if(val!=''){$('.attendance .clear-code').show();}else{$('.attendance .clear-code').hide();}});$('.attendance .signin').click(function(){self.numericSignIn(CodeData,IDData);});$('.attendance .clear-code').click(function(){$('.attendance .code input').val('');$(this).hide();});$('.attendance .code li a').click(function(){var input=$('.attendance .code input');var val=$(this).html();if($(this).is('.erase')){val=input.val();input.val(val.substr(0,val.length-1));}else if($(this).is('.enter')){self.numericSignIn(CodeData,IDData);}else{input.val(input.val()+val);}
input.trigger('change');});$('.attendance .subnav li a').click(function(){if(!$(this).is('.selected')){var cl=$(this).attr('class');$('.attendance .subnav .selected').removeClass('selected');$(this).addClass('selected');$('.attendance .bg .active').removeClass('active');$('.attendance div.'+$(this).attr('attr-name')).addClass('active');Cookies.set('visible-panel',cl);if(cl=='qr'&&$("[name='camera_id']").length==0){self.initQrScanner(IDData);}}});if($('div.qr').is('.active')){this.initQrScanner(IDData);}
$("#signin .close").click(function(){window.clearInterval(self.interval);self.closeModal();});$('#signin .toggle').click(function(){var val=$(this).find('input:checked').val();Cookies.set('multi-session',val);if(val==0){$('#signin').addClass('single');}else{$('#signin').removeClass('single');}});$('.in-progress li').each(function(){var session=this;var ending=parseInt($(this).attr('attr-ending'),10);window.setTimeout(function(){$(session).remove();if($('.in-progress li').length==0){$('.in-progress').hide();}},ending*1000);});$('.upcoming li,.hidden li').each(function(){var session=this;var starting=parseInt($(this).attr('attr-starting'),10);var ending=parseInt($(this).attr('attr-ending'),10);window.setTimeout(function(){var context=$(session).parents('.scroller');if(context.find('.in-progress').length==1){$(session).appendTo(context.find('.in-progress ul'));if($('.in-progress li').length>0){$('.in-progress').show();}}else{$(session).remove();}},starting*1000);window.setTimeout(function(){$(session).remove();if($('.in-progress li').length==0){$('.in-progress').hide();}},ending*1000);});$('.hidden li').each(function(){var session=this;var starting=parseInt($(this).attr('attr-checkin'),10);window.setTimeout(function(){var context=$(session).parents('.scroller');if(context.find('.upcoming').length==1){$(session).appendTo(context.find('.upcoming ul'));if($('.upcoming li').length>0){$('.upcoming').show();}}else{$(session).remove();}},starting*1000);});window.setInterval(function(){location.reload(true);},3600000);$('.signin-confirm').click(function(){if(!$(this).parent().is('.blurred')){self.signIn();}});$('#signin .window').click(function(e){e.stopPropagation();});$('#signin').click(function(){self.closeModal();});$('.sessions .attending').click(function(e){e.stopPropagation();var li=$(this).parents('li');var popup=$('.attending-popup');if(popup.length==0){popup=$('<div class="popup attending-popup"><div class="top"><a class="close icon-cancel-1"></a>'+li.html()+'</div><div class="members"></div></div>').appendTo('body');}else{popup.find('.top').html('<a class="close icon-cancel-1"></a>'+li.html());}
popup.find('.members').html('<span class="spinner dark-spin"></span>');mor.media.overlay(popup);popup.find('.close').click(function(){mor.media.close(popup);});$.get('manager/attendance/attending',{id:$(this).parents('li').attr('attr-id')},function(response){$('.attending-popup .members').html(response);});});$('.checkin_waiver .confirm-waiver .button').click(function(){var ready=true;$(".checkin_waiver input[type='checkbox']").each(function(){if(!$(this).is(':checked')){ready=false;}});if(ready){$('#signin .window').removeClass('show-waiver').scrollTop(0).find("input[type='checkbox']").prop('checked',false);if($('#signin .signin-sessions li:visible').length==0){$('#signin .signin-sessions .placeholder').show();}else{$('#signin .signin-sessions .placeholder').hide();}}else{mor.error(this,'Please check all the boxes before confirming');}});},pickerEvent:function(el){if($(el).is('.active')&&!$(el).is('.previous')){$(el).toggleClass('checked');if($('#signin').is('.single')){this.signIn();}else{if($('.signin-sessions .checked').length>0){$('#signin .confirm').removeClass('blurred');}else{$('#signin .confirm').addClass('blurred');}
if($("#signin input[name='type']").val()=='manager'){$('.signin-sessions .scroller li').addClass('active');}else{this.applyMemberships();}}}},editEvent:function(anchor){var event=$(anchor).parents('li:first');var popup=$('.schedule .event-popup').addClass('editing');popup.find("input,select").each(function(){var name=$(this).attr('name');var dataEl=$(event).find("[attr-name='"+name+"']");if(dataEl.length==1){var val=dataEl.attr('attr-val');if(typeof(val)=='undefined'){val=dataEl.text();}
$(this).val(val);}});popup.find("input[name='id']").val($(event).attr('attr-id'));popup.show().position({my:"left top",at:"left-15 bottom",of:event,collision:'none none'});},removeEvent:function(id){$(".sessions li[attr-id='"+id+"'],.signin-sessions li[attr-id='"+id+"']").remove();$.post('manager/gym/removeevent',{id:id});if($('.sessions .unscheduled li').length==0){$('.unscheduled').hide();}},numericSignIn:function(CodeData,IDData){var input=$('.attendance .code input');var val=input.val();var bc=$("input[name='barcode']");var showError=function(msg){var el=$('<span class="error-message"><span>'+msg+'</span></span>').appendTo($('.attendance div.code'));el.click(function(){$(el).remove();});window.setTimeout(function(){$(el).remove();},2000);};if(val==''){showError('Please enter your code to check-in');}else if(bc.val()=='ID'&&IDData[val]){var data=IDData[val];this.showSigninPopup(data);}else if(val.substring(0,2)=='ID'&&IDData[val.substring(2)]){var val=val.substring(2);this.showSigninPopup(IDData[val]);}else if(CodeData[val]){var data=CodeData[val];this.showSigninPopup(data);}else if(IDData[val]){var data=IDData[val];this.showSigninPopup(data);}else{showError("Incorrect code");input.val('');$('.attendance .clear-code').hide();}},showSigninPopup:function(data){$('.attendance .main .text:focus').blur();var self=this;var popup=$('#signin');if($('.checkin_waiver').length==1){$('#signin .window').addClass('show-waiver');}
popup.find('.name').html(data.label);var parts=data.label.split(' ');if(data.photo!=''){popup.find('.avatar').html('<img src="'+data.photo.replace('-small','')+'" />');}else{var initial=parts[0].substring(0,1);if(typeof(parts[1])!='undefined'){initial+=parts[1].substring(0,1);}
popup.find('.avatar').html(initial);}
popup.find("input[name='id']").val(data.id);if(data.type){popup.find("input[name='type']").val(data.type);}
var id=data.id;popup.find('li.private-training').each(function(){var ids=$(this).attr('attr-booked');if(ids&&ids!=''){ids=ids.split(',');var booked=false;for(var i in ids){if(id==ids[i]){booked=true;}}
if(booked){$(this).show();$(this).parents('div:first').find('h4').show();}else{$(this).hide();if($(this).parent('ul').find('li:visible').length==0){$(this).parents('div:first').find('h4').hide();}}}else{$(this).hide();if($(this).parent('ul').find('li:visible').length==0){$(this).parents('div:first').find('h4').hide();}}});if($("input[name='membership_checkin']").val()==0||data.type=='manager'){$('.signin-sessions .scroller li').addClass('active');}
if(popup.find('.memberships').length==1){$.get('manager/attendance/memberinfo',{id:data.id,type:data.type},function(response){$('#signin .memberships').html(response);$('#signin .memberships .access em').click(function(){$(this).parent().find('.details').toggle();$(this).find('i').toggleClass('icon-angle-down').toggleClass('icon-angle-up');});if((response==''&&$("input[name='membership_checkin']").val()==0)||data.type=='manager'){$('#signin .memberships').hide();}else{$('#signin .memberships').show();}
if($("#signin input[name='checked_ids']").length==1){var prev=$("#signin input[name='checked_ids']").val();if(prev!=''){var prevIds=prev.split(',');for(var i in prevIds){var id=prevIds[i];$(".signin-sessions li[attr-id='"+id+"']").addClass('previous');}}}
if(data.type=='member'||data.type=='visitor'){self.applyMemberships();}});}else{self.autoCheckin();}
popup.show();$('body').addClass('noscroll');if($('#signin .signin-sessions li:visible').length==0){$('#signin .signin-sessions .placeholder').show();}else{$('#signin .signin-sessions .placeholder').hide();}},applyMemberships:function(){var memberId=$("#signin input[name='id']").val();if($("#signin .memberships .overdue[attr-checkin='no']").length>0){$('.signin-sessions li.active').removeClass('active');this.notifyCheckinFailure(memberId,{'error':'Overdue membership payment'});return false;}else if($('#signin .memberships .overdue.required').length>0){$('.signin-sessions li.active').removeClass('active');this.notifyCheckinFailure(memberId,{'error':'Required membership payment'});return false;}
if($('#signin .memberships .no-card').length==1){$('.signin-sessions li.active').removeClass('active');this.notifyCheckinFailure(memberId,{'error':'No card on file'});return false;}
if($('#signin .memberships .docs').length==1){$('.signin-sessions li.active').removeClass('active');this.notifyCheckinFailure(memberId,{'error':'Signature required - '+$('#signin .memberships .docs li:first span').html()});return false;}
if($("input[name='membership_checkin']").val()==1){$('.signin-sessions li.active:not(.checked):not(.previous)').removeClass('active');var sessionCount=[];$('#signin .memberships .ships > li:not(.overdue):not(.frozen):not(.future)').each(function(){var sessionIds=$(this).attr('attr-sessions');var remaining=$(this).find('.remaining').length==1?parseInt($(this).find('.remaining').html(),10):999;sessionCount[$(this).attr('attr-id')]=remaining;var sessions=[];var filter=false;if(typeof(sessionIds)!='undefined'){sessionIds=sessionIds.split(',');filter=[".signin-sessions li[attr-all='yes']"];for(var i in sessionIds){var id=sessionIds[i];filter.push(".signin-sessions li[attr-id='"+id+"']");}}
var sportIds=$(this).attr('attr-sports');if(typeof(sportIds)!='undefined'){sportIds=sportIds.split(',');if(!filter){filter=[".signin-sessions li[attr-all='yes']"];}
for(var i in sportIds){var id=sportIds[i];filter.push(".signin-sessions li[attr-sport='"+id+"']");}}
if(filter){sessions=$(filter.join(','));}else{sessions=$('.signin-sessions li');}
sessions=sessions.not('.active');if(sessions.length>0){remaining=remaining?remaining-sessions.filter('.checked').length:remaining;if(remaining>0){sessions.addClass('active').attr('attr-ship',$(this).attr('attr-id'));}}});}
if($("input[name='checkin_booking']").val()==1||$("#signin .memberships input[name='member_type']").val()==3){$(".signin-sessions li.active[attr-bookable='1']").removeClass('active');if($(".memberships input[name='booked']").length>0){var booked=$(".memberships input[name='booked']").val().split(',');if(booked.length>0){for(var i in booked){var id=booked[i];$(".signin-sessions li[attr-id='"+id+"']:not(.previous)").addClass('active')}}}}
if($('#signin .memberships .disable').length>0){this.notifyCheckinFailure(memberId,{'error':$("#signin .memberships .disable:first").html()});$('.signin-sessions li.active:not(.checked):not(.previous)').removeClass('active');return false;}
if($("input[name='membership_checkin']").val()==1){if($('.signin-sessions li').length>0&&$('.signin-sessions li.active:not(.checked):not(.previous)').length==0){if($('.signin-sessions li').length==$('.signin-sessions li.previous').length){return false;}
if($('#signin .memberships li').length==0){var error={'error':'No active memberships'};}else{if(sessionCount.length>0){for(var id in sessionCount){var count=sessionCount[id];if(count==0&&$('.signin-sessions li.checked').length==0){var error={'error':"No sessions left - "+$("#signin .memberships li[attr-id='"+id+"'] em").text()};}}}
if(typeof(error)==='undefined'){}}
if(typeof(error)!='undefined'){this.notifyCheckinFailure(memberId,error);return false;}}}
this.autoCheckin();},autoCheckin:function(){if($("input[name='checkin_auto']").val()==1){var upcoming=$('.signin-sessions .upcoming li.active:not(.previous):first:visible');var session=$('.signin-sessions .in-progress li.active:not(.previous):last:visible');if(upcoming.length==1){if(session.length==0){upcoming.trigger('click');return;}
var d=new Date();var minutes=d.getHours()*60+d.getMinutes();var upcomingMinutes=(parseInt(upcoming.find("b[attr-name='hour']").attr('attr-val').replace(/^0+(?!\.|$)/,''),0)*60)+(parseInt(upcoming.find("b[attr-name='minute']").attr('attr-val').replace(/^0+(?!\.|$)/,''),0));if(upcomingMinutes-minutes<=15){upcoming.trigger('click');return;}}
if(session.length==0){var session=$(".signin-sessions .unscheduled li.active:not(.previous):first:visible");}
session.trigger('click');}},notifyCheckinFailure:function(memberId,error){error['member_id']=memberId;$.post('manager/attendance/notifyfailure',error);},signIn:function(){var self=this;var popup=$('#signin');var button=popup.find('.confirm .button');if(button.attr('disabled')==='disabled'||(button.is(':visible')&&button.parent().is('.blurred'))){if(button.html()=='Success!'){self.closeModal();button.html(button.data('html'));button.attr('disabled',false);}
return false;}
button.data('html',button.html());button.html('Checking-in <span class="spinner"></span>');button.attr('disabled',true);var data={'id':popup.find("input[name='id']").val(),'type':popup.find("input[name='type']").val()};var ids={};var hasIds=false;popup.find(".signin-sessions li.checked").each(function(){var shipId=$(this).attr('attr-ship');shipId=typeof(shipId)!='undefined'?shipId:"none";ids[$(this).attr('attr-id')]=shipId;hasIds=true;});if(hasIds){data['event_ids']=ids;}else{return false;}
$.post('manager/attendance/newsignin',data,function(response){if(response.success){$('.checkins ul').prepend(response.row);$('.checkins .placeholder').hide();popup.addClass('checked-in');$('.attendance .code .text').val('');button.html('Success!')
if($('#success-sound').length==1){try{$('#success-sound')[0].play();}catch(error){}}
if(hasIds){for(var id in ids){var attending=$(".sessions li[attr-id='"+id+"']").find('.attending').show();var num=parseInt(attending.find('b').text(),10);attending.find('b').text(num+1);var shipId=ids[id];var ship=$(".memberships li[attr-id='"+shipId+"']");if(ship.length==1&&ship.find('.remaining').attr('attr-type')=='pack'){var remaining=parseInt(ship.find('.remaining').text(),10);if(remaining==1){$.post('manager/attendance/shipspent',{ship_id:shipId});}}}}
window.setTimeout(function(){self.closeModal();button.html(button.data('html'));button.attr('disabled',false);},3000);}else{var error=response['errors'];mor.error(button,error);button.html(button.data('html'));button.attr('disabled',false);}},'json');},initQrScanner:function(IDData){var self=this;Html5Qrcode.getCameras().then(function(devices){if(devices&&devices.length){if(devices.length>1){var options='';for(var i in devices){var device=devices[i];options+='<option value="'+device['id']+'">'+device['label']+'</option>';}
var select=$('<select name="camera_id">'+options+'</select>').insertAfter('#qr-reader');select.change(function(){if($('#qr-reader video').length>0){startCamera($(this).val());}});}else{var input=$("<input name='camera_id' value='"+devices[0].id+"' />").insertAfter('#qr-reader');}
startCamera();}}).catch(function(err){});$('.scan-qr').click(function(){startCamera();});var startCamera=function(){var cameraId=$("[name='camera_id']").val();html5QrCode=new Html5Qrcode("qr-reader");$('.qr .stop-qr').css('display','inline-block').one('click',function(){html5QrCode.stop();$('.qr .button').css('display','inline-block');$('.qr .stop-qr').hide();});$('.qr .button').hide();html5QrCode.start(cameraId,{fps:10,},function(qrCode){if(qrCode.substring(0,2)=='ID'){var id=qrCode.substring(2);if(IDData[id]){var data=IDData[id];self.showSigninPopup(data);}}},function(errorMessage){}).catch(function(err){});};},closeModal:function(){var popup=$('#signin');popup.hide();popup.removeClass('checked-in');popup.find('.checked').removeClass('checked');popup.find('.signin-sessions .active').removeClass('active');popup.find('.signin-sessions .previous').removeClass('previous');$('.error-message').remove();$('#signin .confirm').addClass('blurred');$('.attendance .main .text').val('');$('.clear-code').hide();$('body').removeClass('noscroll');},signedIn:function(id){$('.attendance .code .text').val('');},initPromotions:function(){var self=this;$('.expand-skills').click(function(){var popup=$(this).parents('tr').find('.popup');mor.media.overlay(popup);});$('.skills.popup .close').click(function(){mor.media.close($(this).parents('.popup'));});$(".promotions table .attendance input[type='checkbox']").click(function(){var data={id:$(this).val(),member_id:$(this).parents('tr:first').attr('attr-member'),checked:$(this).is(':checked')?1:0,'rank_id':$(this).parents('tr').attr('attr-rank')};$.post('manager/attendance/checkskill',data);});$('.filters .promote').click(function(){$('.promotions .container').addClass('promoting');window.setTimeout(function(){$('.promotions .member-counter .popup').fadeOut(300);},5000);});$('.filters .promote-continue').click(function(){var count=parseInt($('.promotions .member-counter em span').html(),10);if(count>0){var form=$('form.promote-form');var checked=sessionStorage.getItem('promote-ids');var ids=checked.split(',');for(var i in ids){form.append('<input type="hidden" value="'+ids[i]+'" name="ids[]" />');}
sessionStorage.setItem('promote-ids',[]);form.submit();}});$('.filters .cancel').click(function(){$('.promotions .container').removeClass('promoting');$(".promotions .member input[type='checkbox']").prop('checked',false);sessionStorage.setItem('promote-ids',[]);self.storeSelections();});$(".promotions td:first-child input[type='checkbox']").click(function(){self.storeSelections();});var checked=sessionStorage.getItem('promote-ids');if(typeof(checked)=='string'&&checked!=''){var ids=checked.split(',');for(var i in ids){var id=ids[i];var cb=$(".promotions td:first-child input[type='checkbox'][value='"+id+"']");if(cb.length==1){cb.prop('checked',true);}}
var count=ids.length;$(".promotions .member-counter em span").html(count);var total=$(".promotions table tr").length-1;var checked=$(".promotions td:first-child input[type='checkbox']:checked").length;if(count>0){$('.filters .promote-continue').removeClass('disabled');$('.promotions .container').addClass('promoting');$('.promotions .member-counter .popup').hide();}
if(total==checked){$(".mass-select .select-all input[type='checkbox']").prop('checked',true);}}},initPromote:function(){$(window).click(function(e){$('.rank-picker ul').hide();});if(!$('.promotion-form').is('.done')){$('.rank-picker .selected').click(function(e){e.stopPropagation();$('.rank-picker ul').hide();$(this).parent().find('ul').toggle().find('.picked')[0].scrollIntoView();});$('.rank-picker li').click(function(){var id=$(this).attr('attr-id');var picker=$(this).parents('.rank-picker');picker.find('li.picked').removeClass('picked');$(this).addClass('picked');picker.find("input[name*='ranks']").val(id);picker.find('.selected').html($(this).html());});$(".promote-type input").change(function(){if($(this).is(":checked")){var type=$(this).val();if(type==2){$(".promotion-form").addClass('invite');}else{$(".promotion-form").removeClass('invite');}}});$('.promotion-form .remove').click(function(){$(this).parents('tr').fadeOut(200,function(){$(this).remove();});});}
$('.promotion-form .evaluate').click(function(){var popup=$(this).parent().find('.popup');mor.media.overlay(popup);});$('.promotion-form .popup .close,.promotion-form .popup .button').click(function(){mor.media.close($(this).parents('.popup'));if($("input[name='promotion_id']").length==1){var promotionId=$("input[name='promotion_id']").val();var data={promotion_id:promotionId};$(this).parents('.popup').find("textarea").each(function(){data[$(this).attr('name')]=$(this).val();});$("form").find("input[name*='participants']").each(function(){data[$(this).attr('name')]=$(this).val();});$.post('manager/promotions/save',data);}});$('.date').datepicker({firstDay:$("#first_day_week").val(),dateFormat:$('#date-format').val()});},storeSelections:function(){var checked=sessionStorage.getItem('promote-ids');var ids=[];if(typeof(checked)=='string'&&checked!=''){ids=checked.split(',');}
$(".promotions .member input[type='checkbox']").each(function(){var val=$(this).val();var index=ids.indexOf(val);if($(this).prop('checked')){if(index==-1){ids.push(val);}}else{if(index>-1){ids.splice(index,1);}}});if(ids.length>0){$('.filters .promote-continue').removeClass('disabled');}else{$('.filters .promote-continue').addClass('disabled');}
$(".promotions .member-counter em span").html(ids.length);sessionStorage.setItem('promote-ids',ids);},initOverview:function(){var self=this;$('.stats-controls .periods li').click(function(){$('.stats-controls .periods .selected').removeClass('selected');$(this).addClass('selected');$(this).find("input").prop('checked',true);self.refreshGraph();});$('.stats-controls select').change(function(){self.refreshGraph();});var rangeInput=$('.range');if(rangeInput.length>0){var format=$("#range-date-format").val();rangeInput.daterangepicker({locale:{format:format},ranges:{'This Month':[moment().startOf('month'),moment().endOf('month')],'Last 30 Days':[moment().subtract(30,'day'),moment()],'Last Month':[moment().subtract(1,'month').startOf('month'),moment().subtract(1,'month').endOf('month')],'This Year':[moment().startOf('year'),moment().endOf('month')],'Last Year':[moment().subtract(1,'year').startOf('year'),moment().subtract(1,'year').endOf('year')],'Last 12 Months':[moment().subtract(12,'months'),moment()]},showDropdowns:true,alwaysShowCalendars:true,opens:'left',autoApply:true,autoUpdateInput:false});rangeInput.on('apply.daterangepicker',function(ev,picker){$(this).val(picker.startDate.format(format)+' - '+picker.endDate.format(format));self.refreshGraph();});return rangeInput;}},refreshGraph:function(){var data=$('.stats-controls').serialize();$.get('manager/attendance/graphdata',data,function(response){$('.graph-container.checkin-graph').html(response);});},initCheckins:function(){var self=this;mor.main.initDatepicker("right");var popup=$('.event-popup');this.attendanceEvents(".checkins td");this.initLogAttendance();popup.submit(function(e){e.preventDefault();var button=$(this).find('button.button');button.data('html',button.html()).html('Saving <span class="spinner"></span>').prop('disabled',true);var form=this;$.post('manager/attendance/save',$(this).serialize(),function(response){button.html(button.data('html')).prop('disabled',false);if(response.success){var row=$(".checkins tr[attr-id='"+$(form).find("input[name='id']").val()+"']");var newrow=$(response.row).insertAfter(row);row.remove();self.attendanceEvents(newrow);}else{mor.showErrors(response.errors,form);}
mor.media.close(popup);},'json');});var removePopup=$('.remove-log');$('.remove-log .confirm').click(function(){var id=removePopup.find("input[name='id']").val();removePopup.hide();var row=$(".checkins tr[attr-id='"+id+"']").fadeOut(300,function(){$(this).remove();});$.post('manager/attendance/remove',{id:id});});$('html,body,.remove-log .cancel').click(function(){$('.confirmation-popup').fadeOut();$('.users td form').hide();});},attendanceEvents:function(context){var self=this;var popup=$('.event-popup');$(context).find('.icon-pencil').click(function(e){e.stopPropagation();popup.addClass('edit-attendance');var row=$(this).parents('tr:first');mor.media.overlay(popup);var member=row.find("td:first");var id=parseInt(member.attr('attr-member'),10);var date=row.attr('attr-date');popup.find("input[name='checked_in']").val(date);popup.find(".checked_date").datepicker('setDate',date);var edit=function(){var sessionId=parseInt(row.attr('attr-session'));popup.find("input[name='id']").val(row.attr('attr-id'));popup.find("input[name='member_id']").val(id);var session=popup.find(".sessions li[attr-id='"+sessionId+"']");if(session.length==1){session.trigger('click')[0].scrollIntoView();}
if(row.find('.skills').length==1){row.find('.skills .skill').each(function(){popup.find(".skill[attr-id='"+$(this).attr('attr-id')+"']").find("input[type='tel'],select").val($(this).attr('attr-measure'));});}
popup.find('.member').html(row.find('.member-link').html());if(row.find('.notes').length==1){if($("textarea[name='notes']").is(":hidden")){popup.find(".add-note").trigger('click');}
popup.find("textarea[name='notes']").val(row.find('.notes').html());}else if(popup.find("textarea[name='notes']").is(":visible")){popup.find('.add-note').trigger('click');}
var exist=typeof(row.attr('attr-ship'))!='undefined'?row.attr('attr-ship'):0;popup.find(".membership > em").html('Select...');popup.find(".membership input[name='ship_id']").val('')
if(typeof(ships)!='undefined'){if(typeof(ships[id])!='undefined'){var options='<li>Select membership...</li>';for(var i in ships[id]){options+='<li attr-id="'+i+'">'+ships[id][i]+'</li>';}
popup.find(".membership .dropdown").html(options).parent().show();$('.event-popup .membership .dropdown li').click(function(){var id=$(this).attr('attr-id');$(".event-popup .membership input[name='ship_id']").val(id);$('.event-popup .membership em').html($(this).html());});var ship=$(".event-popup .membership .dropdown li[attr-id='"+i+"']");if(ship.length==1){$('.event-popup .membership').addClass('open');ship.trigger('click');}}else{popup.find(".membership .dropdown").html('').parent().hide();}}else if(popup.find(".membership").length==1){var li=popup.find(".membership li[attr-id='"+exist+"']");if(exist>0&&li.length==1){$('.membership').addClass('open');li.trigger('click');}}}
self.showSessions(edit);});var removePopup=$('.remove-log');$(context).find('.icon-trash').click(function(e){e.stopPropagation();var row=$(this).parents('tr:first');removePopup.fadeIn().position({of:this,my:"right bottom-14",at:"right top",collision:"none none"});removePopup.find("input[name='id']").val(row.attr('attr-id'));});$(context).find('.describe').click(function(){var popup=$(this).parents('.skill').find('.popup');mor.media.overlay(popup);});},showSessions:function(callback){var self=this;var popup=$('.event-popup');var date=$(".event-popup input[name='checked_in']").val();var type=1;if($(".event-popup select[name='schedule_type']").length==1){type=$(".event-popup select[name='schedule_type']").val();}
$.get('manager/attendance/getsessions',{date:date,schedule_type:type},function(response){var sessions=$('.event-popup .sessions');sessions.find('.placeholder,ul').remove();sessions.append(response);mor.media.center(popup);self.pickSessions();if(typeof(callback)!='undefined'){callback.call();}});},pickSessions:function(){var popup=$('.event-popup');popup.find('.sessions li').click(function(){if($(this).is('.selected')){return false;}
var id=$(this).find("input[type='radio']").val();popup.find('.sessions .selected').removeClass('selected').find('.measure').remove();$(this).addClass('selected').find("input").prop('checked',true);if(typeof(skills)!='undefined'&&typeof(skills[id])!='undefined'){var html='';var date=$.datepicker.formatDate('yy-mm-dd',popup.find('.checked_date').datepicker('getDate'));var ind=0;for(var i in skills[id]){var skill=skills[id][i];if(skill['date']==null||skill['date']==date){var item='<div class="skill" attr-id="'+skill['id']+'">'+skill['title'];item+='<input name="skills['+ind+'][id]" value="'+skill['id']+'" type="hidden" />';if(skill['type']!=1){if(skill['type']!=4){item+='<label class="measure">';}
if(skill['type']==2){item+='<input type="tel" class="text number" value="10" name="skills['+ind+'][measure]" /> Reps';}else if(skill['type']==4){item+='<input type="hidden" value="0" name="skills['+ind+'][measure]" />'}else{var options='';for(var i=0;i<=200;i=i+1){options+='<option value="'+i+'"'+(i==skill['measure']?(' selected="selected"'):'')+'>'+i+'</option>';}
item+='<select name="skills['+ind+'][measure]">'+options+'</select> Min';}
if(skill['type']!=4){item+='</label>';}}
item+='</div>';html+=item;ind++;}}
if(html!=''){var skillDiv=$('<div class="measure">'+html+'</div>').appendTo(this);}}});},initLogAttendance:function(){var self=this;var popup=$('.event-popup');popup.click(function(e){e.stopPropagation();});popup.find('.close').click(function(){mor.media.close(popup);});this.pickSessions();var dp=$('.event-popup .checked_date');dp.datepicker({firstDay:$("#first_day_week").val(),dateFormat:$('#date-format').val()});dp.datepicker('option','onSelect',function(date,el){dp.find("input[name='checked_in']").val(date);self.showSessions();dp.removeClass('open');});dp.find(".date").keyup(function(){dp.datepicker("setDate",$(this).val())}).change(function(){self.showSessions();});$('.select-box').click(function(e){if($(this).find('.date').is(':focus')&&$(this).is('.open')){return false;}
$(this).toggleClass('open');$('.select-box').not(this).removeClass('open');e.stopPropagation();});dp.find('.ui-datepicker').css('display','').click(function(e){e.stopPropagation();});$(".event-popup select[name='schedule_type']").change(function(){self.showSessions();});$('.event-popup .subnav a').click(function(){$('.event-popup .subnav .selected').removeClass('selected');$(this).addClass('selected');if($(this).is('.show-bulk')){$('.event-popup .bulk,.event-popup .checked_date .past,.event-popup .ships,.event-popup .buttons').show();$('.event-popup .sessions,.event-popup .checked_date .regular,.event-popup .subnav .type,.event-popup .form-skills').hide();popup.find("input[name='past_log']").val(1);}else if($(this).is('.show-skills')){$('.event-popup .bulk,.event-popup .checked_date .past,.event-popup .sessions,.event-popup .subnav .type,.event-popup .ships,.event-popup .buttons').hide();$('.event-popup .form-skills,.event-popup .checked_date .regular').show();}else{$('.event-popup .bulk,.event-popup .checked_date .past,.event-popup .form-skills').hide();$('.event-popup .sessions,.event-popup .checked_date .regular,.event-popup .subnav .type,.event-popup .skills-picker,.event-popup .ships,.event-popup .buttons').show();popup.find("input[name='past_log']").val(0);}
mor.media.center(popup);});$('.event-popup .add-note').click(function(){var notes=$(".event-popup textarea[name='notes']").toggle();$(this).find('i').toggleClass('icon-plus-1').toggleClass('icon-minus');if(notes.is(':hidden')){notes.val('');}
mor.media.center($('.event-popup'));});$('.event-popup').click(function(){$(this).find('.select-box').removeClass('open');});$('.event-popup .membership .dropdown li').click(function(){var id=$(this).attr('attr-id');$('.event-popup .membership .dropdown .selected').removeClass('selected');$(this).addClass('selected');$(".event-popup .membership input[name='ship_id']").val(id);$('.event-popup .membership em').html($(this).html());});},initMembers:function(){this.initLogAttendance();this.attendanceEvents($('.member-attendance td'));if($('.sparkline').length>0){$('.sparkline').sparkline('html',{type:'bar',height:17,barColor:"#444",barWidth:6});}
$('.track').click(function(e){e.stopPropagation();var id=parseInt($(this).parents('tr:first').attr('attr-id'),10);var popup=$('.event-popup');popup.find("input[name='member_id']").val(id);if(typeof(ships)!='undefined'){if(typeof(ships[id])!='undefined'){var options='';for(var i in ships[id]){options+='<li attr-id="'+i+'">'+ships[id][i]+'</li>';}
popup.find(".membership .dropdown").html(options).parent().show();$('.event-popup .membership .dropdown li').click(function(){var id=$(this).attr('attr-id');$(".event-popup .membership input[name='ship_id']").val(id);$('.event-popup .membership em').html($(this).html());});$('.event-popup .membership .dropdown li:first').trigger('click');popup.find('.membership').removeClass('open');}else{popup.find(".membership .dropdown").html('').parent().hide();popup.find(".membership input[name='ship_id']").val('');}}
mor.media.overlay(popup);});if($('.track').length>0){$('.event-popup').submit(function(e){e.preventDefault();var form=$(this);var id=$(this).find("input[name='member_id']").val();var data=$(this).serialize();var button=$(this).find('.buttons button');button.prop('disabled',true).data('html',button.html());button.html('Logging <i class="spinner"></i>');$.post('manager/attendance/track',data,function(response){button.html(button.data('html')).prop('disabled',false);if(response.success){var format=$('#date-format').val().toUpperCase().replace('YY','YYYY');var to=false,from=false,compare=false;var range=$(".filters input[name='range']");if(range.length==1){if(range.val()!=''){var parts=range.val().split(' - ');from=moment(parts[0],format);to=moment(parts[1],format);}
var dateInput=$(form).find("input[name='checked_in']");if(dateInput.val()!=''){compare=moment(dateInput.val(),format);}
var inRange=true;if(compare&&to&&from){inRange=compare.isBetween(to,from);}
if(inRange){var el=$("tr[attr-id='"+id+"'] .hours");el.html(parseFloat(el.html(),10)+response['hours']);if(form.find("select[name='event_id']").val()!=''){var el=$("tr[attr-id='"+id+"'] .visits");el.html(parseInt(el.html(),10)+1);}}}
var notes=form.find("textarea[name='notes']");if(notes.is(':visible')){form.find('.add-note').trigger('click');}
mor.media.close(form);}else{for(var i in response.errors){var el=form.find("[name='"+i+"']");if(el.length==0){el=form.find('button');}
var error=response.errors[i];if(typeof(error)=='object'){for(var i in error){error=error[i];}}
mor.error(el,error);}}},'json');});var ranges={'This Month':[moment().startOf('month'),moment().endOf('month')],'Last Month':[moment().subtract(1,'month').startOf('month'),moment().subtract(1,'month').endOf('month')],'Last 3 Months':[moment().subtract(3,'month').startOf('month'),moment().subtract(1,'month').endOf('month')],'This Year':[moment().startOf('year'),moment().endOf('year')],};mor.main.initDatepicker("right",ranges);}},initSessions:function(){$('.filters .date').datepicker({firstDay:$("#first_day_week").val(),dateFormat:$('#date-format').val()});$('.sparkline').sparkline('html',{type:'bar',height:17,barColor:"#444",barWidth:5,tooltipFormat:$.spformat('{{value}}','sparktip')});mor.main.initDatepicker("right");},initMultiCheckin:function(){$('.date').datepicker({firstDay:$("#first_day_week").val(),dateFormat:$('#date-format').val()});$(".date").datepicker("option","buttonText","");$('.date').datepicker('option','showOn','both');$('.date').datepicker('option','onSelect',function(date,el){loadSessions();});var loadSessions=function(date){var loader=$('<span class="spinner"></span>').insertBefore($('.session-heading'));var date=$('.date').val();var params={date:date};if($("select[name='schedule_type']").length==1){params['schedule_type']=$("select[name='schedule_type']").val();}
$.get('manager/attendance/getsessions',params,function(response){loader.remove();$('.multi-checkin .sessions .scroller').html(response);pickSessions();$('.members .scroller').html('');resetCounter()
$(".search-container").hide();});};$("select[name='schedule_type']").change(function(){loadSessions();});var setProgram=function(id){if(id==''){var options='<option>Select program...</option>';}else{var options='<option>All Ranks / Levels</option>';if(typeof(ranks[id])!='undefined'){for(var i in ranks[id]){var rank=ranks[id][i];if(typeof(rank['id'])!='undefined'){options+='<option value="'+rank['id']+'">'+rank['rank']+'</option>';}}}}
$("select[name='rank_id']").html(options);};var toggleMember=function(el){$(el).toggleClass('selected');var count=$('.multi-checkin .members li.selected').length;$('.members .bottom .counter b').html(count);if(count>0){$('.members .bottom').removeClass('disabled');}else{$('.members .bottom').addClass('disabled');}};var resetCounter=function(){$('.members .bottom').addClass('disabled');$('.members .bottom .counter b').html('0');}
var refreshMembers=function(){var selected=$('.sessions li.selected');if(selected.length==1){$('input.search').val('').next().hide();var id=$(selected).attr('attr-id');var data={session_id:id,sport_id:$("select[name='sport_id']").val(),'rank_id':$("select[name='rank_id']").val(),date:$("input.date").val()};if($("select[name='gym']").length==1){data['gym']=$("select[name='gym']").val();}
if($("input[name='has_access']").is(":checked")){data['has_access']=1;}
if($("input[name='booked']").is(":checked")){data['has_bookings']=1;}
if($("input[name='include_staff']").is(":checked")){data['include_staff']=1;}
var loader=$('<span class="spinner dark-spin"></span>').appendTo($('.multi-checkin .members'));$.get('manager/attendance/getmembers',data,function(response){loader.remove();$('.multi-checkin .members .scroller').html(response);if($('.multi-checkin .members li').length>0){$('.members .search-container').show();}else{$('.members .search-container').hide();}
$('.multi-checkin .members .scroller').scrollTop(0);$('.multi-checkin .members li').click(function(){toggleMember(this);});resetCounter();});}}
$("select[name='sport_id']").change(function(){setProgram($(this).val());refreshMembers();});$("select[name='rank_id']").change(function(){refreshMembers();});var pickSessions=function(){$('.sessions li').click(function(){if($(this).is('.checked')){return false;}
$('.sessions .selected').removeClass('selected');$(this).addClass('selected');var sportId=$(this).attr('attr-sport');if(typeof(sportId)!='undefined'){$("select[name='sport_id']").val(sportId);setProgram(sportId);}else{$("select[name='sport_id']").val('');setProgram('');}
refreshMembers();});};pickSessions();$(".sessions input[type='checkbox']").click(function(){refreshMembers();});$("select[name='gym']").change(function(){refreshMembers();});$("input[name='search']").keyup(function(){var search=$(this).val().toLowerCase();if(search==''){$('.members li').show();$('.search-container i').hide();}else{$('.multi-checkin .members li .name').each(function(){var parts=$(this).text().toLowerCase().split(' ');var visible=false;for(var i in parts){if(parts[i].indexOf(search)==0){visible=true;}}
if(visible){$(this).parent().show();}else{$(this).parent().hide();}});$('.search-container i').show();}});$('.multi-checkin .members .search-container i').click(function(){$(this).prev().val('').trigger('keyup');});$('.multi-checkin .members .bottom .button').click(function(){if($(this).parent().is('.disabled')){return false;}
var members=[];$(".multi-checkin .members li.selected").each(function(){var member={id:$(this).attr('attr-id')};if(typeof($(this).attr('attr-ship'))!='undefined'){member['ship_id']=$(this).attr('attr-ship');}
if(typeof($(this).attr('attr-per'))!='undefined'){member['per_session']=1;}
if(typeof($(this).attr('attr-last'))!='undefined'){member['last_session']=1;}
if($(this).attr('attr-type')=='staff'){member['staff']=1;}
members.push(member);});var data={members:members,session_id:$(".sessions .selected").attr('attr-id'),date:$("input.date").val()};if($("select[name='gym']").length==1){data['academy_id']=$("select[name='gym']").val();}
var button=$(this);button.data('html',button.html()).prop('disabled',true);button.html('Checking-in <span class="spinner"></span>');$.post('manager/attendance/multi',data,function(response){if(response==0){mor.error(button,'Could not complete check-in');button.html(button.data('html')).prop('disabled',false);}else{$('.members .selected').addClass('checked').removeClass('selected');button.html('Success!');window.setTimeout(function(){button.html(button.data('html')).prop('disabled',false);},2000);}});});},initSettings:function(){$("input[name='show_checkin_waiver']").change(function(){if($(this).is(":checked")){var val=$(this).val();if(val==1){$('.waiver-area').show();}else{$('.waiver-area').hide();}}});var updateFieldInput=function(){var ids=[];$('ul.card-fields li').each(function(){ids.push($(this).attr('attr-id'));});$("input[name='card_fields']").val(ids.join(','));}
var removeField=function(icon){$(icon).parents('li').remove();updateFieldInput();if($('ul.card-fields li').length<2){$(".field-form").show();}};$('ul.card-fields .remove-field').click(function(){removeField(this);});$('.add-field').click(function(){var fieldId=$("select[name='field_id']").val();if(fieldId!=''){var title=$("select[name='field_id'] option:selected").text();var item=$('<li attr-id="'+$("select[name='field_id']").val()+'">'+title+' <a class="remove-field icon-cancel-1"></a></li>').appendTo('ul.card-fields');item.find('.remove-field').click(function(){removeField(this);});if($('ul.card-fields li').length==2){$(".field-form").hide();}
updateFieldInput();}});}};mor.attendance=attendance;$(document).ready(function(){attendance.init();});})();